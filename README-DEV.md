# Developer README

## Directory organization

  * `data` -- not installed data,
  * `doc` -- documentation,
  * `test` -- testing scripts and examples,
  * `thot` -- Thot module,
  * `thot/data` -- installed data,
  * `thot/mods` -- usable modules,
  * `thot/backs` -- backends,
  * `thot/langs` -- language modules,
  * `slidy` -- to remove,
  * `exp` -- to remove.


## Testing

To avoid conflict with installed version, define the PYTHONPATH to the
top directory :

```
$ export PYTHONPATH=$PWD:$PYTHONPATH
```

## Documentation

Read it from an HTTP local server:
```
$ pydoc3 -b
```

## Adding module

Just add `.py` in `thot/mods`.

Put data in `thot/data` and complete `MANIFEST.in`.


## Design


### Resource management

There is basic two use cases :

* [UC1] Generic generators (like Latex w/o PDF, DocBook, ...) require some files to be available ( _used_ ) or to _create_ additional files in order to generate a new document and the used/created files are no more needed.

* [UC2] Typically HTML generators _use_ files or needs to _create_ files that have to be delivered with the HTML files themselves. In addition, links needs to be set up to link together HTML files and used/created resources.

For [UC1], original use case of Thot, the used/created files was named _friend files_ but HTML back-end already required to build links and [UC2] was a bit enforced for HTML.

For this new version of Thot, [UC2] has to be fully implemneted to support _jusrt-in-time_ file navigation ( ``thot-view`` ) or to support static site generation ( ``thot-web`` ). In this cases, used/created files may be shared among the different generated HTML pages and the link making must be adapted to the different pages. This is why we changed the back-end to support the following interface.

A ``Generator`` object is created for each generated page. Used/created files are called _resources_ and are handled by the generator in the following way:

  * ``use_resource(path)`` add the resource whose path is given to the generated pages and returns the path that is used in the generation. If needed, the resource is copied by Thot.

  * ``new_resource(path, ext)`` creates a new resource in the generated files and return the path to this resource.

  * ``get_out_path()`` -- get the path of the generated file.

  * ``get_resource_path(path)`` -- that gives the link to the resource whose path is given (as returned by ``use_resource()`` or ``make_resource()``) and produce a link adapted to the page generated by gen (the generator).


The generator, in order to support multiple document generation strategies, provides a function ``get_manager()`` that returns an ``Manager``. Basically, the _manager_ contains the functions below:

  * ``use_resource(path)`` -- as in ``Generator``.

  * ``new_resource(path, ext)`` -- as in ``Generator``.

  * ``get_resource_path(path, generator)`` -- as in ``Generator`` but takes the generator as parameter.

**otawa-gen** -- document generation named _ID_.thot in directory _DIR_
  * ``use_resource``(path) returns path as-is if path is in _DIR_.
  * ``use_resource``(path) copies the resource in _ID_-imports else.
  * ``new_resource``(path) creates the resource in _ID_-imports.

**otawa-view** -- document generation named _ID_.thot in directory _DIR_
  * ``use_resource``(path) returns path as-is.
  * ``new_resource``(path) creates the resource in temporary directory.

**otawa-web** -- document generation named _ID_.thot in directory _DIR_
  * ``use_resource``(path) copies the resource in directory ``static``.
  * ``new_resource``(path) creates the resource in directory ``static``.


### Life cycle of resources

The life cycle described concerns used and new resources. The first step only applies for used resources.

1. A used resource is first defined in the read file by its _input path_. If relative, the _input path_ has to be fixed to be relative to the directory containing the document: this is made in the parser. The result is often relative to the current working directory but absolute paths are also supported.

2. A used resource or a new resource has to be declared to the generator or to the generator system and is returned as a special path called a _build_path_. This is usually an absolute path but symbolic paths may also be used. This is performed in the generator or by any generation module. _build_path_ allows to share the same resource accross different generated documents.

3. When the document is generated, the _build_paths_ has to be turned in _output_paths_ that depends on the output format or in the strategy of generation of the manager.
